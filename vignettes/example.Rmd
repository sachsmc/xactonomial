---
title: "Basic Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(xactmomial)
```


```{r, cache = TRUE}

n = c(8, 11)

sample_data <- function() {
  
  T1 <- rmultinom(1, n[1], prob = c(.25, .25, .25, .25))
  T2 <- rmultinom(1, n[2], prob = c(.05, .15, .5, .3))
  
  list(T1 = c(T1), T2 = c(T2))
  
}

psi <- function(theta) {
  
  theta1 <- theta[1:4]
  theta2 <- theta[5:8]
  sum(sqrt(theta1 * theta2)) |> acos() |> log()
  
}

true_psi <- psi(c(.25, .25, .25, .25, .05, .15, .5, .3))

## how bad is the bootstrap?

run_one_bs <- function(i) {
  data <- sample_data()
  
  bsamps <- replicate(2000, {
    unlist(lapply(data, \(x) {
      #newx <- c(rmultinom(1, sum(x), prob = x / sum(x)))
      newx <- table(factor(sample(rep.int(1:length(x), times = x), sum(x), replace = TRUE), 
             levels = 1:length(x)))
      
      newx / sum(newx)
    })) |> psi()
  })
  
  cib <- quantile(bsamps, c(.025, .975))
  true_psi >= cib[1] & true_psi <= cib[2]
    
}

cover_boot <- sapply(1:1000, run_one_bs)
mean(cover_boot)
```


```{r}
results <- xactonomial(psi, data, alpha = .05)

exp(results$estimate)
exp(results$conf.int)

results$pvalue_function(psi0 = log(.5))

```


