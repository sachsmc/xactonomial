---
title: "Basic Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(xactonomial)
library(parallel)
```


```{r, cache = TRUE}

n = c(8, 10)
true_theta <- c(.45, .15, .3, .1, .05, .15, .4, .4)

sample_data <- function() {
  
  T1 <- rmultinom(1, n[1], prob = true_theta[1:4])
  T2 <- rmultinom(1, n[2], prob = true_theta[5:8])
  
  list(T1 = c(T1), T2 = c(T2))
  
}

psi <- function(theta) {
  
  theta1 <- theta[1:4]
  theta2 <- theta[5:8]
  sum(sqrt(theta1 * theta2))
  
}

true_psi <- psi(true_theta)

## how bad is the bootstrap?

run_one_bs <- function(i) {
  data <- sample_data()
  
  bsamps <- replicate(2000, {
    unlist(lapply(data, \(x) {
      #newx <- c(rmultinom(1, sum(x), prob = x / sum(x)))
      newx <- table(factor(sample(rep.int(1:length(x), times = x), sum(x), replace = TRUE), 
             levels = 1:length(x)))
      
      newx / sum(newx)
    })) |> psi()
  })
  
  cib <- quantile(bsamps, c(.05, .95))
  true_psi >= cib[1] & true_psi <= cib[2]
    
}

cover_boot <- mclapply(1:200, run_one_bs, mc.cores = 100)
mean(unlist(cover_boot))
```


```{r}

xmres <- mclapply(1:200, \(i) {
  
    data <- sample_data()
    results <- xactonomial(psi, data, alpha = .1, psi_limits = c(0,1))
  
  results$conf.int
}, mc.cores = 100)

```
